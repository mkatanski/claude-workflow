# ForEach with Break - Early Loop Termination
# Demonstrates: break tool for conditional loop exit
# Use case: Search through items and stop when found

type: claude-workflow
version: 2

name: "ForEach Break Workflow"

claude:
  interactive: true
  dangerously_skip_permissions: true

tmux:
  split: vertical
  idle_time: 3.0

steps:
  # Set up search target
  - name: "Set search target"
    tool: set
    var: target_value
    value: "charlie"

  # Set up list to search
  - name: "Set users list"
    tool: set
    var: users
    value: '["alice", "bob", "charlie", "diana", "eve"]'

  # Initialize found flag
  - name: "Initialize found flag"
    tool: set
    var: found
    value: "false"

  - name: "Initialize found index"
    tool: set
    var: found_at
    value: "-1"

  # Search with break
  - name: "Search for target user"
    tool: foreach
    source: users
    item_var: user
    index_var: idx
    on_item_error: continue
    steps:
      - name: "Check current user"
        tool: bash
        command: "echo 'Checking index {idx}: {user}'"
        output_var: check_output

      # Break if we found the target
      - name: "Break if found"
        tool: break
        when: "{user} == {target_value}"

      - name: "Continue message"
        tool: bash
        command: "echo 'Not found yet, continuing...'"

  # After loop - report results
  - name: "Report search result"
    tool: bash
    command: "echo 'Search complete. Last checked: {user} at index {idx}'"
    output_var: search_result

  # Another example: break on numeric condition
  - name: "Set numbers"
    tool: set
    var: numbers
    value: '[1, 5, 12, 3, 8, 25, 7]'

  - name: "Initialize sum"
    tool: set
    var: running_sum
    value: "0"

  - name: "Sum until threshold"
    tool: foreach
    source: numbers
    item_var: num
    index_var: num_idx
    steps:
      - name: "Add to sum"
        tool: bash
        command: "echo $(( {running_sum} + {num} ))"
        output_var: running_sum

      - name: "Report current sum"
        tool: bash
        command: "echo 'Added {num}, sum is now {running_sum}'"

      # Break when sum exceeds 20
      - name: "Break if sum too high"
        tool: break
        when: "{running_sum} > 20"

  - name: "Final sum report"
    tool: bash
    command: "echo 'Final sum: {running_sum} (stopped early if > 20)'"
    output_var: final_sum
