# Nested ForEach - Matrix Operations
# Demonstrates: foreach within foreach for nested iteration
# Use case: Processing hierarchical data structures

type: claude-workflow
version: 2

name: "Nested ForEach Workflow"

claude:
  interactive: true
  dangerously_skip_permissions: true

tmux:
  split: vertical
  idle_time: 3.0

steps:
  # Set up nested data structure
  - name: "Set teams data"
    tool: set
    var: teams
    value: |
      [
        {"name": "backend", "members": ["alice", "bob"]},
        {"name": "frontend", "members": ["charlie", "diana"]},
        {"name": "devops", "members": ["eve"]}
      ]

  - name: "Initialize total count"
    tool: set
    var: total_members
    value: "0"

  # Outer loop: iterate over teams
  - name: "Process all teams"
    tool: foreach
    source: teams
    item_var: team
    index_var: team_idx
    on_item_error: continue
    steps:
      - name: "Extract team name"
        tool: bash
        command: "echo '{team}' | grep -o '\"name\":\"[^\"]*\"' | cut -d'\"' -f4"
        output_var: team_name

      - name: "Team header"
        tool: bash
        command: "echo '=== Processing team {team_idx}: {team_name} ==='"

      - name: "Extract members array"
        tool: bash
        command: "echo '{team}' | grep -o '\"members\":\\[[^]]*\\]' | sed 's/\"members\"://' | tr -d '[]\"' | tr ',' '\n'"
        output_var: members_list

      # Inner loop: iterate over team members
      - name: "Process team members"
        tool: foreach
        source: members_list
        item_var: member
        index_var: member_idx
        on_item_error: continue
        steps:
          - name: "Process member"
            tool: bash
            command: "echo '  Member {member_idx}: {member} (Team: {team_name})'"
            output_var: member_output

          - name: "Increment counter"
            tool: bash
            command: "echo $(( {total_members} + 1 ))"
            output_var: total_members

      - name: "Team complete"
        tool: bash
        command: "echo 'Completed team: {team_name}'"

  # Summary
  - name: "Print summary"
    tool: bash
    command: "echo 'Total members processed: {total_members}'"
    output_var: summary

  # Second example: Coordinate grid (simpler nested loop)
  - name: "Set X coordinates"
    tool: set
    var: x_coords
    value: '["A", "B", "C"]'

  - name: "Set Y coordinates"
    tool: set
    var: y_coords
    value: '["1", "2"]'

  - name: "Grid header"
    tool: bash
    command: "echo '=== Generating coordinate grid ==='"

  - name: "Generate grid"
    tool: foreach
    source: x_coords
    item_var: x
    index_var: x_idx
    steps:
      - name: "Process row"
        tool: foreach
        source: y_coords
        item_var: y
        index_var: y_idx
        steps:
          - name: "Print coordinate"
            tool: bash
            command: "echo 'Coordinate: ({x}, {y})'"
            output_var: coord

  - name: "Grid complete"
    tool: bash
    command: "echo 'Grid generation complete'"
    output_var: grid_done
