# While Loop Example
# Demonstrates condition-based looping with all options
# Use while when iterations depend on dynamic conditions

type: claude-workflow
version: 2
name: "While Loop Demo"
description: "Showcase while tool for condition-based looping"

steps:
  # ============================================================
  # BASIC: Count up until threshold
  # ============================================================
  - name: "Initialize counter"
    tool: set
    var: counter
    value: "0"

  - name: "Count to 5"
    tool: while
    condition: "{counter} < 5"
    max_iterations: 10
    steps:
      - name: "Current count: {counter}"
        tool: bash
        command: "echo 'Counter is now: {counter}'"

      - name: "Increment counter"
        tool: bash
        command: "echo $(( {counter} + 1 ))"
        output_var: counter

  - name: "Final counter value"
    tool: bash
    command: "echo 'Final counter: {counter}'"

  # ============================================================
  # PRACTICAL: Poll for status change
  # ============================================================
  - name: "Initialize deployment status"
    tool: set
    var: deploy_status
    value: "pending"

  - name: "Set poll count"
    tool: set
    var: poll_count
    value: "0"

  - name: "Poll until ready"
    tool: while
    condition: "{deploy_status} != ready"
    max_iterations: 5
    steps:
      - name: "Check deployment status (poll {poll_count})"
        tool: bash
        command: |
          # Simulate status check - becomes ready on poll 3
          poll={poll_count}
          if [ "$poll" -ge 2 ]; then
            echo "ready"
          else
            echo "pending"
          fi
        output_var: deploy_status

      - name: "Update poll count"
        tool: bash
        command: "echo $(( {poll_count} + 1 ))"
        output_var: poll_count

      - name: "Wait between polls"
        tool: bash
        command: "echo 'Status: {deploy_status}, waiting...'"
        when: "{deploy_status} != ready"

  - name: "Deployment complete"
    tool: bash
    command: "echo 'Deployment is now: {deploy_status}'"

  # ============================================================
  # STRING CONDITION: Process until empty
  # ============================================================
  - name: "Initialize queue"
    tool: set
    var: queue_items
    value: "item1,item2,item3"

  - name: "Process queue until empty"
    tool: while
    condition: "{queue_items} is not empty"
    max_iterations: 10
    steps:
      - name: "Get next item from queue"
        tool: bash
        command: |
          # Get first item
          echo "{queue_items}" | cut -d',' -f1
        output_var: current_item

      - name: "Process: {current_item}"
        tool: bash
        command: "echo 'Processing: {current_item}'"

      - name: "Remove processed item"
        tool: bash
        command: |
          # Remove first item, return rest
          remaining=$(echo "{queue_items}" | cut -d',' -f2-)
          # Check if we consumed the last item
          if [ "$remaining" = "{queue_items}" ]; then
            echo ""
          else
            echo "$remaining"
          fi
        output_var: queue_items

  - name: "Queue empty"
    tool: bash
    command: "echo 'All queue items processed'"

  # ============================================================
  # MAX_ITERATIONS: Safety limit with on_max_reached
  # ============================================================
  - name: "Initialize infinite loop demo"
    tool: set
    var: always_true
    value: "true"

  - name: "Loop with safety limit"
    tool: while
    condition: "{always_true} == true"
    max_iterations: 3
    on_max_reached: continue
    steps:
      - name: "This will run max 3 times"
        tool: bash
        command: "echo 'Running iteration (max_iterations will stop this)'"

  - name: "Safely exited infinite loop"
    tool: bash
    command: "echo 'Loop stopped by max_iterations, workflow continues'"

  # ============================================================
  # COMPLEX CONDITION: Multiple conditions with AND
  # ============================================================
  - name: "Setup multi-condition check"
    tool: context
    action: set
    values:
      retries_left: "3"
      found_result: "false"

  - name: "Search with retry limit"
    tool: while
    condition: "{found_result} == false and {retries_left} > 0"
    max_iterations: 5
    steps:
      - name: "Search attempt (retries left: {retries_left})"
        tool: bash
        command: |
          # Simulate search - succeeds when retries_left hits 1
          if [ {retries_left} -eq 1 ]; then
            echo "true"
          else
            echo "false"
          fi
        output_var: found_result

      - name: "Decrement retries"
        tool: bash
        command: "echo $(( {retries_left} - 1 ))"
        output_var: retries_left

  - name: "Search complete"
    tool: bash
    command: "echo 'Found result: {found_result}, Retries remaining: {retries_left}'"

  # ============================================================
  # NESTED USAGE: While inside foreach
  # ============================================================
  - name: "Process multiple services"
    tool: foreach
    items: ["api", "web", "worker"]
    item_var: service
    steps:
      - name: "Initialize {service} status"
        tool: set
        var: svc_status
        value: "starting"

      - name: "Set {service} check count"
        tool: set
        var: svc_checks
        value: "0"

      - name: "Wait for {service} to be ready"
        tool: while
        condition: "{svc_status} != running"
        max_iterations: 3
        steps:
          - name: "Check {service} ({svc_checks})"
            tool: bash
            command: |
              # Simulate: service becomes running on check 2
              if [ {svc_checks} -ge 1 ]; then
                echo "running"
              else
                echo "starting"
              fi
            output_var: svc_status

          - name: "Increment check"
            tool: bash
            command: "echo $(( {svc_checks} + 1 ))"
            output_var: svc_checks

      - name: "Service {service} ready"
        tool: bash
        command: "echo '{service} is now {svc_status}'"

  - name: "All services ready"
    tool: bash
    command: "echo 'While loop demo complete!'"
