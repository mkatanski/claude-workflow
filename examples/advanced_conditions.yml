# Advanced Conditions
# Demonstrates: compound conditions with AND/OR, string matching, numeric comparisons
# Use case: Complex decision logic in workflows

type: claude-workflow
version: 2

name: "Advanced Conditions Workflow"

claude:
  interactive: true
  dangerously_skip_permissions: true

tmux:
  split: vertical
  idle_time: 3.0

steps:
  # ===========================================
  # Setup: Initialize test variables
  # ===========================================

  - name: "Set environment"
    tool: set
    var: env
    value: "production"

  - name: "Set retry count"
    tool: set
    var: retry_count
    value: "2"

  - name: "Set max retries"
    tool: set
    var: max_retries
    value: "3"

  - name: "Set status"
    tool: set
    var: status
    value: "success"

  - name: "Set log message"
    tool: set
    var: log_message
    value: "ERROR: Connection refused to database server"

  - name: "Set filename"
    tool: set
    var: filename
    value: "report_2024.json"

  - name: "Set http code"
    tool: set
    var: http_code
    value: "201"

  # ===========================================
  # Compound AND conditions
  # ===========================================

  - name: "Check production AND success"
    tool: bash
    command: "echo 'Production deployment successful!'"
    when: "{env} == production and {status} == success"
    output_var: prod_success

  - name: "Check retries available"
    tool: bash
    command: "echo 'Can retry: {retry_count} < {max_retries}'"
    when: "{retry_count} < {max_retries} and {status} != success"
    output_var: can_retry

  # This should NOT run (status is success, not failure)
  - name: "Retry needed check"
    tool: bash
    command: "echo 'This should not appear'"
    when: "{status} == failure and {retry_count} < {max_retries}"
    output_var: retry_needed

  # ===========================================
  # Compound OR conditions
  # ===========================================

  - name: "Check critical environment"
    tool: bash
    command: "echo 'Running in critical environment: {env}'"
    when: "{env} == production or {env} == staging"
    output_var: critical_env

  - name: "Check dev environment"
    tool: bash
    command: "echo 'This should not appear - not dev'"
    when: "{env} == development or {env} == local"
    output_var: dev_env

  # ===========================================
  # String pattern matching
  # ===========================================

  - name: "Check for ERROR in log"
    tool: bash
    command: "echo 'Found error in logs!'"
    when: "{log_message} contains ERROR"
    output_var: has_error

  - name: "Check no WARNING in log"
    tool: bash
    command: "echo 'No warnings found'"
    when: "{log_message} not contains WARNING"
    output_var: no_warning

  - name: "Check JSON file"
    tool: bash
    command: "echo 'Processing JSON file: {filename}'"
    when: "{filename} ends with .json"
    output_var: is_json

  - name: "Check report file"
    tool: bash
    command: "echo 'This is a report file'"
    when: "{filename} starts with report"
    output_var: is_report

  # ===========================================
  # Numeric range checks
  # ===========================================

  - name: "Check HTTP success (2xx)"
    tool: bash
    command: "echo 'HTTP request successful: {http_code}'"
    when: "{http_code} >= 200 and {http_code} < 300"
    output_var: http_success

  - name: "Set error code"
    tool: set
    var: error_code
    value: "404"

  - name: "Check HTTP client error (4xx)"
    tool: bash
    command: "echo 'HTTP client error: {error_code}'"
    when: "{error_code} >= 400 and {error_code} < 500"
    output_var: http_client_error

  # ===========================================
  # Empty/not empty checks
  # ===========================================

  - name: "Set empty var"
    tool: set
    var: empty_value
    value: ""

  - name: "Set non-empty var"
    tool: set
    var: non_empty_value
    value: "has content"

  - name: "Check empty variable"
    tool: bash
    command: "echo 'Variable is empty'"
    when: "{empty_value} is empty"
    output_var: is_empty

  - name: "Check non-empty variable"
    tool: bash
    command: "echo 'Variable has content: {non_empty_value}'"
    when: "{non_empty_value} is not empty"
    output_var: is_not_empty

  # ===========================================
  # Complex combined conditions
  # ===========================================

  - name: "Complex production check"
    tool: bash
    command: "echo 'Production ready: env={env}, status={status}, retries={retry_count}'"
    when: "{env} == production and {status} == success and {retry_count} < {max_retries}"
    output_var: complex_check

  - name: "Error in production"
    tool: bash
    command: "echo 'ALERT: Error detected in production!'"
    when: "{env} == production and {log_message} contains ERROR"
    output_var: prod_error_alert

  # ===========================================
  # Summary
  # ===========================================

  - name: "Conditions complete"
    tool: bash
    command: "echo 'Advanced conditions workflow complete'"
    output_var: done
