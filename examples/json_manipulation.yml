# JSON/YAML Tool Example
# Demonstrates native JSON and YAML manipulation using JMESPath queries
# Supports: query, set, update, delete actions

type: claude-workflow
version: 2
name: "JSON/YAML Manipulation Demo"
description: "Showcase json tool with JMESPath queries and YAML support"

steps:
  # ============================================================
  # SETUP: Create sample JSON file for demos
  # ============================================================
  - name: "Create sample package.json"
    tool: bash
    command: |
      cat > /tmp/demo-package.json << 'EOF'
      {
        "name": "demo-project",
        "version": "1.0.0",
        "description": "Demo project for JSON examples",
        "main": "index.js",
        "scripts": {
          "test": "jest",
          "build": "tsc",
          "lint": "eslint ."
        },
        "dependencies": {
          "express": "^4.18.0",
          "lodash": "^4.17.21"
        },
        "devDependencies": {
          "typescript": "^5.0.0",
          "jest": "^29.0.0"
        },
        "keywords": ["demo", "test"],
        "author": "Developer",
        "license": "MIT"
      }
      EOF
      echo "Sample JSON created"

  # ============================================================
  # ACTION: query - Extract values using JMESPath
  # ============================================================
  - name: "Query: Get project name"
    tool: json
    action: query
    file: "/tmp/demo-package.json"
    query: "name"  # JMESPath: no leading dot
    output_var: project_name

  - name: "Show project name"
    tool: bash
    command: "echo 'Project name: {project_name}'"

  - name: "Query: Get version"
    tool: json
    action: query
    file: "/tmp/demo-package.json"
    query: "version"
    output_var: version

  - name: "Show version"
    tool: bash
    command: "echo 'Version: {version}'"

  # ============================================================
  # QUERY: Nested paths (JMESPath)
  # ============================================================
  - name: "Query: Get test script"
    tool: json
    action: query
    file: "/tmp/demo-package.json"
    query: "scripts.test"  # JMESPath nested access
    output_var: test_command

  - name: "Show test command"
    tool: bash
    command: "echo 'Test command: {test_command}'"

  - name: "Query: Get express version"
    tool: json
    action: query
    file: "/tmp/demo-package.json"
    query: "dependencies.express"
    output_var: express_version

  - name: "Show express version"
    tool: bash
    command: "echo 'Express: {express_version}'"

  # ============================================================
  # QUERY: Array access and projections
  # ============================================================
  - name: "Query: Get first keyword"
    tool: json
    action: query
    file: "/tmp/demo-package.json"
    query: "keywords[0]"  # JMESPath array index
    output_var: first_keyword

  - name: "Show first keyword"
    tool: bash
    command: "echo 'First keyword: {first_keyword}'"

  - name: "Query: Get last keyword"
    tool: json
    action: query
    file: "/tmp/demo-package.json"
    query: "keywords[-1]"  # JMESPath negative index
    output_var: last_keyword

  - name: "Show last keyword"
    tool: bash
    command: "echo 'Last keyword: {last_keyword}'"

  # ============================================================
  # QUERY: JMESPath functions
  # ============================================================
  - name: "Query: Count keywords"
    tool: json
    action: query
    file: "/tmp/demo-package.json"
    query: "length(keywords)"  # JMESPath length function
    output_var: keyword_count

  - name: "Show keyword count"
    tool: bash
    command: "echo 'Keyword count: {keyword_count}'"

  - name: "Query: Get all dependency keys"
    tool: json
    action: query
    file: "/tmp/demo-package.json"
    query: "keys(dependencies)"  # JMESPath keys function
    output_var: dep_keys

  - name: "Show dependency keys"
    tool: bash
    command: "echo 'Dependencies: {dep_keys}'"

  # ============================================================
  # ACTION: set - Set/update values in JSON file
  # ============================================================
  - name: "Set: Update version"
    tool: json
    action: set
    file: "/tmp/demo-package.json"
    path: ".version"
    value: "2.0.0"

  - name: "Verify version update"
    tool: json
    action: query
    file: "/tmp/demo-package.json"
    query: "version"
    output_var: new_version

  - name: "Show updated version"
    tool: bash
    command: "echo 'Version updated to: {new_version}'"

  # ============================================================
  # SET: Add new nested value
  # ============================================================
  - name: "Set: Add new script"
    tool: json
    action: set
    file: "/tmp/demo-package.json"
    path: ".scripts.start"
    value: "node index.js"

  - name: "Set: Add repository info"
    tool: json
    action: set
    file: "/tmp/demo-package.json"
    path: ".repository"
    value:
      type: "git"
      url: "https://github.com/user/demo-project"

  - name: "Verify new fields"
    tool: bash
    command: "cat /tmp/demo-package.json | grep -A2 'repository'"

  # ============================================================
  # ACTION: update - Modify existing values
  # ============================================================
  - name: "Update: Add new dependency (merge)"
    tool: json
    action: update
    file: "/tmp/demo-package.json"
    path: ".dependencies"
    operation: merge
    value:
      axios: "^1.6.0"
      dotenv: "^16.0.0"

  - name: "Verify merged dependencies"
    tool: bash
    command: "cat /tmp/demo-package.json | grep -A10 'dependencies'"

  # ============================================================
  # UPDATE: Append to array
  # ============================================================
  - name: "Update: Append keyword"
    tool: json
    action: update
    file: "/tmp/demo-package.json"
    path: ".keywords"
    operation: append
    value: "json-demo"

  - name: "Verify appended keyword"
    tool: json
    action: query
    file: "/tmp/demo-package.json"
    query: "keywords"
    output_var: all_keywords

  - name: "Show all keywords"
    tool: bash
    command: "echo 'Keywords: {all_keywords}'"

  # ============================================================
  # UPDATE: Prepend to array
  # ============================================================
  - name: "Update: Prepend keyword"
    tool: json
    action: update
    file: "/tmp/demo-package.json"
    path: ".keywords"
    operation: prepend
    value: "first-keyword"

  - name: "Verify prepended keyword"
    tool: json
    action: query
    file: "/tmp/demo-package.json"
    query: "keywords[0]"
    output_var: first_kw

  - name: "Show first keyword"
    tool: bash
    command: "echo 'First keyword is now: {first_kw}'"

  # ============================================================
  # ACTION: delete - Remove values
  # ============================================================
  - name: "Delete: Remove devDependency"
    tool: json
    action: delete
    file: "/tmp/demo-package.json"
    path: ".devDependencies.jest"

  - name: "Verify deletion"
    tool: bash
    command: |
      if grep -q '"jest"' /tmp/demo-package.json; then
        echo "jest still present"
      else
        echo "jest removed successfully"
      fi

  - name: "Delete: Remove license field"
    tool: json
    action: delete
    file: "/tmp/demo-package.json"
    path: ".license"

  # ============================================================
  # QUERY FROM VARIABLE: Work with JSON in variables
  # ============================================================
  - name: "Simulate API response"
    tool: bash
    command: |
      echo '{"status":"success","data":{"user":{"id":123,"name":"John Doe","email":"john@example.com"},"metadata":{"timestamp":"2024-01-15","version":"1.0"}}}'
    output_var: api_response

  - name: "Query: Extract user from API response"
    tool: json
    action: query
    source: api_response
    query: "data.user.name"  # JMESPath syntax
    output_var: user_name

  - name: "Show user from API"
    tool: bash
    command: "echo 'User name from API: {user_name}'"

  - name: "Query: Extract timestamp"
    tool: json
    action: query
    source: api_response
    query: "data.metadata.timestamp"
    output_var: api_timestamp

  - name: "Show timestamp"
    tool: bash
    command: "echo 'API timestamp: {api_timestamp}'"

  # ============================================================
  # YAML FILE SUPPORT
  # ============================================================
  - name: "Create sample YAML config"
    tool: bash
    command: |
      cat > /tmp/demo-config.yaml << 'EOF'
      name: my-app
      version: 1.0.0
      database:
        host: localhost
        port: 5432
        name: mydb
      features:
        - authentication
        - caching
        - logging
      servers:
        - name: web1
          port: 80
        - name: web2
          port: 8080
        - name: db1
          port: 5432
      EOF
      echo "Sample YAML created"

  - name: "Query: Get YAML config name"
    tool: json
    action: query
    file: "/tmp/demo-config.yaml"
    query: "name"
    output_var: yaml_name

  - name: "Show YAML name"
    tool: bash
    command: "echo 'YAML config name: {yaml_name}'"

  - name: "Query: Get database host from YAML"
    tool: json
    action: query
    file: "/tmp/demo-config.yaml"
    query: "database.host"
    output_var: db_host

  - name: "Show DB host"
    tool: bash
    command: "echo 'Database host: {db_host}'"

  - name: "Query: Get all server names (JMESPath projection)"
    tool: json
    action: query
    file: "/tmp/demo-config.yaml"
    query: "servers[*].name"  # JMESPath array projection
    output_var: server_names

  - name: "Show server names"
    tool: bash
    command: "echo 'Server names: {server_names}'"

  - name: "Query: Filter servers by port (JMESPath filter)"
    tool: json
    action: query
    file: "/tmp/demo-config.yaml"
    query: "servers[?port > `1000`].name"  # JMESPath filter with backtick literal
    output_var: high_port_servers

  - name: "Show high port servers"
    tool: bash
    command: "echo 'Servers with port > 1000: {high_port_servers}'"

  - name: "Set: Update YAML config"
    tool: json
    action: set
    file: "/tmp/demo-config.yaml"
    path: ".version"
    value: "2.0.0"

  - name: "Verify YAML update"
    tool: json
    action: query
    file: "/tmp/demo-config.yaml"
    query: "version"
    output_var: yaml_version

  - name: "Show updated YAML version"
    tool: bash
    command: "echo 'YAML version updated to: {yaml_version}'"

  # ============================================================
  # PRACTICAL: Build JSON config
  # ============================================================
  - name: "Create empty config"
    tool: bash
    command: "echo '{}' > /tmp/app-config.json"

  - name: "Build config: Set environment"
    tool: json
    action: set
    file: "/tmp/app-config.json"
    path: ".environment"
    value: "production"

  - name: "Build config: Set database"
    tool: json
    action: set
    file: "/tmp/app-config.json"
    path: ".database"
    value:
      host: "localhost"
      port: 5432
      name: "myapp"

  - name: "Build config: Set features"
    tool: json
    action: set
    file: "/tmp/app-config.json"
    path: ".features"
    value:
      authentication: true
      caching: true
      logging: false

  - name: "Show built config"
    tool: bash
    command: "cat /tmp/app-config.json"

  # ============================================================
  # PRACTICAL: Iterate over JSON array with JMESPath
  # ============================================================
  - name: "Create users JSON"
    tool: bash
    command: |
      echo '[{"id":1,"name":"Alice","active":true},{"id":2,"name":"Bob","active":false},{"id":3,"name":"Carol","active":true}]' > /tmp/users.json
    output_var: users_json

  - name: "Query: Get all user names (JMESPath projection)"
    tool: json
    action: query
    file: "/tmp/users.json"
    query: "[*].name"  # JMESPath projection on root array
    output_var: user_names

  - name: "Show all user names"
    tool: bash
    command: "echo 'Users: {user_names}'"

  - name: "Query: Get active users (JMESPath filter)"
    tool: json
    action: query
    file: "/tmp/users.json"
    query: "[?active == `true`].name"  # JMESPath filter
    output_var: active_users

  - name: "Show active users"
    tool: bash
    command: "echo 'Active users: {active_users}'"

  - name: "Query: Count active users"
    tool: json
    action: query
    file: "/tmp/users.json"
    query: "length([?active == `true`])"  # JMESPath function with filter
    output_var: active_count

  - name: "Show active user count"
    tool: bash
    command: "echo 'Active user count: {active_count}'"

  # ============================================================
  # CLEANUP
  # ============================================================
  - name: "Clean up demo files"
    tool: bash
    command: |
      rm -f /tmp/demo-package.json /tmp/app-config.json /tmp/users.json /tmp/demo-config.yaml
      echo "Cleanup complete"

  - name: "JSON/YAML manipulation demo complete"
    tool: bash
    command: "echo 'All JSON/YAML examples completed!'"
