# JSON Tool Example
# Demonstrates native JSON manipulation: query, set, update, delete
# Use json tool for working with JSON files and variables

type: claude-workflow
version: 2
name: "JSON Manipulation Demo"
description: "Showcase all json tool actions: query, set, update, delete"

steps:
  # ============================================================
  # SETUP: Create sample JSON file for demos
  # ============================================================
  - name: "Create sample package.json"
    tool: bash
    command: |
      cat > /tmp/demo-package.json << 'EOF'
      {
        "name": "demo-project",
        "version": "1.0.0",
        "description": "Demo project for JSON examples",
        "main": "index.js",
        "scripts": {
          "test": "jest",
          "build": "tsc",
          "lint": "eslint ."
        },
        "dependencies": {
          "express": "^4.18.0",
          "lodash": "^4.17.21"
        },
        "devDependencies": {
          "typescript": "^5.0.0",
          "jest": "^29.0.0"
        },
        "keywords": ["demo", "test"],
        "author": "Developer",
        "license": "MIT"
      }
      EOF
      echo "Sample JSON created"

  # ============================================================
  # ACTION: query - Extract values from JSON file
  # ============================================================
  - name: "Query: Get project name"
    tool: json
    action: query
    file: "/tmp/demo-package.json"
    query: ".name"
    output_var: project_name

  - name: "Show project name"
    tool: bash
    command: "echo 'Project name: {project_name}'"

  - name: "Query: Get version"
    tool: json
    action: query
    file: "/tmp/demo-package.json"
    query: ".version"
    output_var: version

  - name: "Show version"
    tool: bash
    command: "echo 'Version: {version}'"

  # ============================================================
  # QUERY: Nested paths
  # ============================================================
  - name: "Query: Get test script"
    tool: json
    action: query
    file: "/tmp/demo-package.json"
    query: ".scripts.test"
    output_var: test_command

  - name: "Show test command"
    tool: bash
    command: "echo 'Test command: {test_command}'"

  - name: "Query: Get express version"
    tool: json
    action: query
    file: "/tmp/demo-package.json"
    query: ".dependencies.express"
    output_var: express_version

  - name: "Show express version"
    tool: bash
    command: "echo 'Express: {express_version}'"

  # ============================================================
  # QUERY: Array access
  # ============================================================
  - name: "Query: Get first keyword"
    tool: json
    action: query
    file: "/tmp/demo-package.json"
    query: ".keywords[0]"
    output_var: first_keyword

  - name: "Show first keyword"
    tool: bash
    command: "echo 'First keyword: {first_keyword}'"

  # ============================================================
  # ACTION: set - Set/update values in JSON file
  # ============================================================
  - name: "Set: Update version"
    tool: json
    action: set
    file: "/tmp/demo-package.json"
    path: ".version"
    value: "2.0.0"

  - name: "Verify version update"
    tool: json
    action: query
    file: "/tmp/demo-package.json"
    query: ".version"
    output_var: new_version

  - name: "Show updated version"
    tool: bash
    command: "echo 'Version updated to: {new_version}'"

  # ============================================================
  # SET: Add new nested value
  # ============================================================
  - name: "Set: Add new script"
    tool: json
    action: set
    file: "/tmp/demo-package.json"
    path: ".scripts.start"
    value: "node index.js"

  - name: "Set: Add repository info"
    tool: json
    action: set
    file: "/tmp/demo-package.json"
    path: ".repository"
    value:
      type: "git"
      url: "https://github.com/user/demo-project"

  - name: "Verify new fields"
    tool: bash
    command: "cat /tmp/demo-package.json | grep -A2 'repository'"

  # ============================================================
  # ACTION: update - Modify existing values
  # ============================================================
  - name: "Update: Add new dependency (merge)"
    tool: json
    action: update
    file: "/tmp/demo-package.json"
    path: ".dependencies"
    operation: merge
    value:
      axios: "^1.6.0"
      dotenv: "^16.0.0"

  - name: "Verify merged dependencies"
    tool: bash
    command: "cat /tmp/demo-package.json | grep -A10 'dependencies'"

  # ============================================================
  # UPDATE: Append to array
  # ============================================================
  - name: "Update: Append keyword"
    tool: json
    action: update
    file: "/tmp/demo-package.json"
    path: ".keywords"
    operation: append
    value: "json-demo"

  - name: "Verify appended keyword"
    tool: json
    action: query
    file: "/tmp/demo-package.json"
    query: ".keywords"
    output_var: all_keywords

  - name: "Show all keywords"
    tool: bash
    command: "echo 'Keywords: {all_keywords}'"

  # ============================================================
  # UPDATE: Prepend to array
  # ============================================================
  - name: "Update: Prepend keyword"
    tool: json
    action: update
    file: "/tmp/demo-package.json"
    path: ".keywords"
    operation: prepend
    value: "first-keyword"

  - name: "Verify prepended keyword"
    tool: json
    action: query
    file: "/tmp/demo-package.json"
    query: ".keywords[0]"
    output_var: first_kw

  - name: "Show first keyword"
    tool: bash
    command: "echo 'First keyword is now: {first_kw}'"

  # ============================================================
  # ACTION: delete - Remove values
  # ============================================================
  - name: "Delete: Remove devDependency"
    tool: json
    action: delete
    file: "/tmp/demo-package.json"
    path: ".devDependencies.jest"

  - name: "Verify deletion"
    tool: bash
    command: |
      if grep -q '"jest"' /tmp/demo-package.json; then
        echo "jest still present"
      else
        echo "jest removed successfully"
      fi

  - name: "Delete: Remove license field"
    tool: json
    action: delete
    file: "/tmp/demo-package.json"
    path: ".license"

  # ============================================================
  # QUERY FROM VARIABLE: Work with JSON in variables
  # ============================================================
  - name: "Simulate API response"
    tool: bash
    command: |
      echo '{"status":"success","data":{"user":{"id":123,"name":"John Doe","email":"john@example.com"},"metadata":{"timestamp":"2024-01-15","version":"1.0"}}}'
    output_var: api_response

  - name: "Query: Extract user from API response"
    tool: json
    action: query
    source: api_response
    query: ".data.user.name"
    output_var: user_name

  - name: "Show user from API"
    tool: bash
    command: "echo 'User name from API: {user_name}'"

  - name: "Query: Extract timestamp"
    tool: json
    action: query
    source: api_response
    query: ".data.metadata.timestamp"
    output_var: api_timestamp

  - name: "Show timestamp"
    tool: bash
    command: "echo 'API timestamp: {api_timestamp}'"

  # ============================================================
  # PRACTICAL: Build JSON config
  # ============================================================
  - name: "Create empty config"
    tool: bash
    command: "echo '{}' > /tmp/app-config.json"

  - name: "Build config: Set environment"
    tool: json
    action: set
    file: "/tmp/app-config.json"
    path: ".environment"
    value: "production"

  - name: "Build config: Set database"
    tool: json
    action: set
    file: "/tmp/app-config.json"
    path: ".database"
    value:
      host: "localhost"
      port: 5432
      name: "myapp"

  - name: "Build config: Set features"
    tool: json
    action: set
    file: "/tmp/app-config.json"
    path: ".features"
    value:
      authentication: true
      caching: true
      logging: false

  - name: "Show built config"
    tool: bash
    command: "cat /tmp/app-config.json"

  # ============================================================
  # PRACTICAL: Iterate over JSON array
  # ============================================================
  - name: "Create users JSON"
    tool: bash
    command: |
      echo '[{"id":1,"name":"Alice"},{"id":2,"name":"Bob"},{"id":3,"name":"Carol"}]' > /tmp/users.json
    output_var: users_json

  - name: "Query: Get all users as list"
    tool: json
    action: query
    file: "/tmp/users.json"
    query: ".[].name"
    output_var: user_names

  - name: "Show all user names"
    tool: bash
    command: "echo 'Users: {user_names}'"

  # ============================================================
  # CLEANUP
  # ============================================================
  - name: "Clean up demo files"
    tool: bash
    command: |
      rm -f /tmp/demo-package.json /tmp/app-config.json /tmp/users.json
      echo "Cleanup complete"

  - name: "JSON manipulation demo complete"
    tool: bash
    command: "echo 'All JSON examples completed!'"
