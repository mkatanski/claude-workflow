type: claude-step
version: 1
name: "Git Commit"
description: "Stage and commit changes with a message"

inputs:
  - name: message
    description: "Commit message"
    required: true
    schema:
      type: string
      minLength: 1
  - name: add_all
    description: "Stage all changes before committing"
    required: false
    default: true
    schema:
      type: boolean
  - name: allow_empty
    description: "Allow creating an empty commit"
    required: false
    default: false
    schema:
      type: boolean

outputs:
  - name: commit_sha
    description: "SHA of the created commit"
    from: new_commit_sha
  - name: committed
    description: "Whether a commit was created"
    from: was_committed

steps:
  - name: Stage all changes
    tool: bash
    command: "git add -A"
    when: "{inputs.add_all} == true"

  - name: Check if there are changes to commit
    tool: bash
    command: |
      if [ -n "$(git diff --cached --name-only)" ]; then
        echo "true"
      else
        echo "false"
      fi
    output_var: has_staged

  - name: Create commit
    tool: bash
    command: "git commit -m \"{inputs.message}\""
    when: "{has_staged} == true"
    on_error: continue

  - name: Create empty commit
    tool: bash
    command: "git commit --allow-empty -m \"{inputs.message}\""
    when: "{has_staged} == false and {inputs.allow_empty} == true"
    on_error: continue

  - name: Get new commit SHA
    tool: bash
    command: "git rev-parse --short HEAD"
    output_var: new_commit_sha

  - name: Set committed flag
    tool: bash
    command: |
      if [ "{has_staged}" = "true" ] || [ "{inputs.allow_empty}" = "true" ]; then
        echo "true"
      else
        echo "false"
      fi
    output_var: was_committed
